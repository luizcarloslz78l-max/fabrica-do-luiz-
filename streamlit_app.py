import streamlit as st
import google.generativeai as genai
import os
import re

# Configura√ß√£o da p√°gina
st.set_page_config(page_title="F√°brica do Luiz", page_icon="üèóÔ∏è", layout="wide")

# --- FUN√á√ïES AUXILIARES ---
def limpar_codigo(texto):
    """Extrai apenas o c√≥digo Python de dentro de blocos Markdown, se houver."""
        # O padr√£o procura por blocos que come√ßam com ```python e terminam com ```
            padrao = r"```python(.*?)```"
                match = re.search(padrao, texto, re.DOTALL)
                    if match:
                            return match.group(1).strip()
                                # Se n√£o houver formata√ß√£o markdown, tenta retornar o texto original limpo
                                    return texto.replace("```", "").strip()

                                    # --- CONFIGURA√á√ÉO DA CHAVE ---
                                    # Busca a chave de API nos Secrets do Streamlit ou vari√°veis de ambiente
                                    if 'GEMINI_API_KEY' in st.secrets:
                                        minha_chave = st.secrets['GEMINI_API_KEY']
                                        else:
                                            minha_chave = os.environ.get('GEMINI_API_KEY')

                                            # --- INTERFACE PRINCIPAL ---
                                            st.title("üèóÔ∏è F√ÅBRICA DO LUIZ")
                                            st.subheader("Orquestrador de Software com IA Nativa")
                                            st.markdown("""
                                            Esta f√°brica gera c√≥digo Python **pronto para uso** para novos aplicativos Streamlit.
                                            O c√≥digo gerado j√° inclui:
                                            - üß† Integra√ß√£o com Gemini
                                            - üí¨ Interface de Chat com Hist√≥rico (Mem√≥ria)
                                            - üîë Gest√£o inteligente de API Key
                                            """)
                                            st.write("---")

                                            # Verifica√ß√£o de seguran√ßa da chave da F√°brica
                                            if not minha_chave:
                                                st.error("üîê ERRO NA F√ÅBRICA: Configure a GEMINI_API_KEY para a f√°brica funcionar.")
                                                    st.info("Dica: V√° em Settings > Secrets no seu Dashboard do Streamlit ou use o arquivo secrets.toml.")
                                                        st.stop()

                                                        # Configura o motor da F√°brica
                                                        genai.configure(api_key=minha_chave)
                                                        motor = genai.GenerativeModel('gemini-1.5-flash')

                                                        # √Årea de Entrada
                                                        col1, col2 = st.columns([2, 1])

                                                        with col1:
                                                            missao = st.text_area("O que este novo aplicativo deve fazer?", 
                                                                                    placeholder="Ex: Um assistente de estudo que cria quizzes sobre Biologia...",
                                                                                                            height=150)

                                                                                                            with col2:
                                                                                                                st.write("### Par√¢metros")
                                                                                                                    criatividade = st.slider("N√≠vel de Criatividade do C√≥digo", 0.0, 1.0, 0.7)
                                                                                                                        st.write(" ")
                                                                                                                            btn_fabricar = st.button("üöÄ FABRICAR AGORA", type="primary", use_container_width=True)

                                                                                                                            # L√≥gica de Gera√ß√£o
                                                                                                                            if btn_fabricar:
                                                                                                                                if not missao:
                                                                                                                                        st.warning("‚ö†Ô∏è Por favor, descreva a miss√£o do app primeiro.")
                                                                                                                                            else:
                                                                                                                                                    with st.spinner("ü§ñ Arquitetando solu√ß√£o, escrevendo c√≥digo e depurando..."):
                                                                                                                                                                try:
                                                                                                                                                                                # Instru√ß√£o t√©cnica para a IA gerar o c√≥digo correto
                                                                                                                                                                                                instrucao = f"""
                                                                                                                                                                                                                Atue como um Especialista em Streamlit e Python.
                                                                                                                                                                                                                                Sua tarefa √© escrever um script Python √öNICO E EXECUT√ÅVEL para a seguinte miss√£o: "{missao}".

                                                                                                                                                                                                                                                REQUISITOS OBRIGAT√ìRIOS DO C√ìDIGO GERADO:
                                                                                                                                                                                                                                                                1. Imports: `streamlit`, `google.generativeai`, `os`.
                                                                                                                                                                                                                                                                                2. Configura√ß√£o da API Key (CR√çTICO): 
                                                                                                                                                                                                                                                                                                   - Tente ler `st.secrets["GEMINI_API_KEY"]`.
                                                                                                                                                                                                                                                                                                                      - Se falhar, use `st.sidebar.text_input` para pedir a chave ao usu√°rio.
                                                                                                                                                                                                                                                                                                                                         - Se n√£o houver chave configurada, use st.info("Insira a chave na lateral") e st.stop().
                                                                                                                                                                                                                                                                                                                                                         3. Chat e Mem√≥ria:
                                                                                                                                                                                                                                                                                                                                                                            - Use `st.session_state` para armazenar o hist√≥rico (mensagens).
                                                                                                                                                                                                                                                                                                                                                                                               - Exiba as mensagens usando `st.chat_message`.
                                                                                                                                                                                                                                                                                                                                                                                                               4. Modelo: Use `gemini-1.5-flash`.
                                                                                                                                                                                                                                                                                                                                                                                                                               5. N√ÉO inclua explica√ß√µes fora do c√≥digo, responda apenas com o bloco de c√≥digo Python formatado.
                                                                                                                                                                                                                                                                                                                                                                                                                                               """
                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               resposta = motor.generate_content(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   instrucao,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       generation_config=genai.types.GenerationConfig(temperature=criatividade)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       codigo_bruto = resposta.text
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       codigo_limpo = limpar_codigo(codigo_bruto)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       st.success("‚úÖ Aplicativo Fabricado com Sucesso!")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       # Exibi√ß√£o do resultado
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       tab1, tab2 = st.tabs(["üìÑ C√≥digo Fonte", "üíæ Download"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       with tab1:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           st.code(codigo_limpo, language='python')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           with tab2:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               st.write("Salve o arquivo como `app.py` e execute localmente.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   st.download_button(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           label="üì• Baixar arquivo .py",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   data=codigo_limpo,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           file_name="meu_app_gerado.py",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   mime="text/x-python"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   st.error(f"üí• Ocorreu um erro na linha de montagem: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   st.write("---")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   st.caption("F√°brica do Luiz | Monitoramento Estrat√©gico Abril 2026")